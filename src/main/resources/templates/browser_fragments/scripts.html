<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="scripts">
  <script th:inline="javascript">
    /*<![CDATA[*/
    // Функция для установки темы
    function setTheme(theme) {
        if (theme === 'auto') {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('theme-dark');
                document.documentElement.classList.remove('theme-light');
            } else {
                document.documentElement.classList.add('theme-light');
                document.documentElement.classList.remove('theme-dark');
            }
            localStorage.setItem('theme', 'auto');
        } else {
            document.documentElement.classList.remove('theme-light', 'theme-dark');
            document.documentElement.classList.add(`theme-${theme}`);
            localStorage.setItem('theme', theme);
        }
    }

    // Загрузка сохраненной темы или использование системной
    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');

        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            setTheme('auto');
        }
    }

    // Функция для навигации
    function navigateToPath(path) {
        try {
            if (!path) return;

            // Кодируем путь для URL
            const encodedPath = encodeURIComponent(path);
            window.location.href = '/yt-dlp/browse?path=' + encodedPath;
        } catch (e) {
            console.error('Error navigating to path:', e);
            navigateToRoot();
        }
    }

    function navigateToRoot() {
        window.location.href = '/yt-dlp/browse';
    }

    // Функция для выбора текущей директории
    function selectCurrentDirectory() {
        try {
            // Получаем текущий путь из данных страницы
            const currentPathElement = document.querySelector('code');
            const currentPath = currentPathElement ? currentPathElement.textContent : '';

            if (currentPath && currentPath !== '' && window.opener) {
                window.opener.postMessage({
                    type: 'directorySelected',
                    path: currentPath
                }, '*');
                window.close();
            } else if (currentPath && currentPath !== '') {
                alert('Выбрана папка: ' + currentPath);
                window.close();
            } else {
                alert('Пожалуйста, выберите папку');
            }
        } catch (e) {
            console.error('Error selecting directory:', e);
            alert('Ошибка при выборе папки');
        }
    }

    // Отключаем кнопки выбора при ошибке
    document.addEventListener('DOMContentLoaded', function() {
        loadTheme();

        const errorExists = document.querySelector('.alert-danger');
        if (errorExists) {
            document.getElementById('selectButton').disabled = true;
            document.getElementById('footerSelectButton').disabled = true;

            // Фокус на кнопке "В корень"
            const rootBtn = document.querySelector('[onclick="navigateToRoot()"]');
            if (rootBtn) rootBtn.focus();
        }

        // Добавляем обработчики для всех элементов с data-path
        document.querySelectorAll('[data-path]').forEach(item => {
            item.addEventListener('click', function() {
                navigateToPath(this.getAttribute('data-path'));
            });
        });
    });

    // Обработка нажатия клавиш
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const errorExists = document.querySelector('.alert-danger');
            if (!errorExists) {
                selectCurrentDirectory();
            }
        } else if (e.key === 'Escape') {
            window.close();
        }
    });
    /*]]>*/
  </script>
</div>
</body>
</html>