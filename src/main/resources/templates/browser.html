<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="theme-light">
<head>
  <meta charset="UTF-8">
  <title>Выбор папки для загрузки</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg: #ffffff;
        --border-color: #dee2e6;
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
    }

    .theme-dark {
        --bg-color: #1a1d21;
        --text-color: #e9ecef;
        --card-bg: #2a2e33;
        --border-color: #40464e;
        --primary-color: #3b82f6;
        --secondary-color: #94a3b8;
        --success-color: #22c55e;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 0.875rem;
        padding: 0.5rem;
        transition: background-color 0.3s, color 0.3s;
    }

    .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.75rem;
    }

    .card-header {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
    }

    .card-body {
        padding: 1rem;
    }

    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }

    .btn-group-compact .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .theme-switcher {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }

    .directory-item {
        cursor: pointer;
        transition: background-color 0.2s;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .directory-item:hover {
        background-color: var(--primary-color);
        color: white;
    }

    .file-item {
        color: var(--secondary-color);
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .error-card {
        border: 2px solid var(--danger-color);
    }

    .breadcrumb {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0.5rem;
        background-color: var(--card-bg);
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }

    .list-group-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 0.5rem;
    }

    .alert {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
    }
  </style>
</head>
<body>
<div class="theme-switcher">
  <div class="btn-group btn-group-sm btn-group-compact">
    <button class="btn btn-outline-secondary" onclick="setTheme('light')">
      <i class="fas fa-sun"></i>
    </button>
    <button class="btn btn-outline-secondary" onclick="setTheme('dark')">
      <i class="fas fa-moon"></i>
    </button>
    <button class="btn btn-outline-secondary" onclick="setTheme('auto')">
      <i class="fas fa-desktop"></i>
    </button>
  </div>
</div>

<div class="container mt-2">
  <div class="card" th:class="${error != null} ? 'error-card' : ''">
    <div class="card-header d-flex justify-content-between align-items-center py-1">
      <h5 class="mb-0">
        <i class="fas fa-folder-open me-1"></i>
        Выберите папку для загрузки
      </h5>
      <div>
        <button type="button" class="btn btn-sm btn-outline-primary me-1"
                onclick="navigateToRoot()">
          <i class="fas fa-home"></i>
        </button>
        <button type="button" class="btn btn-sm btn-success"
                id="selectButton"
                onclick="selectCurrentDirectory()">
          <i class="fas fa-check me-1"></i>Выбрать
        </button>
      </div>
    </div>
    <div class="card-body p-2">
      <!-- Ошибки -->
      <div th:if="${error != null}" class="alert alert-danger mb-2">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <i class="fas fa-exclamation-circle me-1"></i>
            <strong>Ошибка:</strong>
            <span th:text="${error}"></span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                  onclick="navigateToRoot()">
            <i class="fas fa-home"></i>
          </button>
        </div>
      </div>

      <!-- Контент при отсутствии ошибок -->
      <div th:if="${error == null}">
        <!-- Корневой уровень -->
        <div th:if="${drives != null}">
          <h6 class="mb-2">Доступные диски:</h6>
          <div class="list-group">
            <a th:each="drive : ${drives}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${drive}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-hdd me-1 text-primary"></i>
              <span th:text="${drive}"></span>
            </a>
          </div>
        </div>

        <!-- Уровень с папками -->
        <div th:if="${currentPath != null and drives == null}">
          <!-- Навигация -->
          <nav class="mb-2">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="#" onclick="navigateToRoot()">Корень</a>
              </li>
              <li class="breadcrumb-item active" th:text="${currentPath}"></li>
            </ol>
          </nav>

          <!-- Содержимое папки -->
          <div class="list-group">
            <!-- Кнопка "Наверх" -->
            <a th:if="${parentPath != null}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${parentPath}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-arrow-up me-1 text-muted"></i>
              На уровень выше
            </a>

            <!-- Папки -->
            <a th:each="item : ${items}"
               th:if="${item.directory}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${item.path}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-folder me-1 text-warning"></i>
              <span th:text="${item.name}"></span>
            </a>

            <!-- Файлы -->
            <div th:each="item : ${items}"
                 th:unless="${item.directory}"
                 class="list-group-item file-item">
              <i class="fas fa-file me-1 text-secondary"></i>
              <span th:text="${item.name}"></span>
              <small class="float-end" th:text="${item.size}"></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Сообщение при ошибке -->
      <div th:if="${error != null}" class="text-center py-3">
        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
        <h5 class="text-danger">Не удалось открыть директорию</h5>
        <p class="text-muted">Пожалуйста, выберите другую папку или вернитесь в корневую директорию</p>
        <button type="button" class="btn btn-primary btn-sm" onclick="navigateToRoot()">
          <i class="fas fa-home me-1"></i>Вернуться в корень
        </button>
      </div>
    </div>
    <div class="card-footer py-1">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted" th:if="${currentPath != null and error == null}">
          Текущий путь: <code th:text="${currentPath}"></code>
        </small>
        <small class="text-muted" th:if="${error != null}">
          Неверный путь: <code th:text="${currentPath}"></code>
        </small>
        <div>
          <button type="button" class="btn btn-outline-primary btn-sm me-1"
                  onclick="navigateToRoot()">
            <i class="fas fa-home"></i>
          </button>
          <button type="button" class="btn btn-secondary btn-sm me-1"
                  onclick="window.close()">
            Отмена
          </button>
          <button type="button" class="btn btn-primary btn-sm"
                  id="footerSelectButton"
                  onclick="selectCurrentDirectory()">
            <i class="fas fa-check me-1"></i>Выбрать
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Функция для установки темы
  function setTheme(theme) {
      if (theme === 'auto') {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.documentElement.classList.add('theme-dark');
              document.documentElement.classList.remove('theme-light');
          } else {
              document.documentElement.classList.add('theme-light');
              document.documentElement.classList.remove('theme-dark');
          }
          localStorage.setItem('theme', 'auto');
      } else {
          document.documentElement.classList.remove('theme-light', 'theme-dark');
          document.documentElement.classList.add(`theme-${theme}`);
          localStorage.setItem('theme', theme);
      }
  }

  // Загрузка сохраненной темы или использование системной
  function loadTheme() {
      const savedTheme = localStorage.getItem('theme');

      if (savedTheme) {
          setTheme(savedTheme);
      } else {
          setTheme('auto');
      }
  }

  // Функция для навигации
  function navigateToPath(path) {
      try {
          if (!path) return;

          // Кодируем путь для URL
          const encodedPath = encodeURIComponent(path);
          window.location.href = '/yt-dlp/browse?path=' + encodedPath;
      } catch (e) {
          console.error('Error navigating to path:', e);
          navigateToRoot();
      }
  }

  function navigateToRoot() {
      window.location.href = '/yt-dlp/browse';
  }

  // Функция для выбора текущей директории
  function selectCurrentDirectory() {
      try {
          // Получаем текущий путь из данных страницы
          const currentPathElement = document.querySelector('code');
          const currentPath = currentPathElement ? currentPathElement.textContent : '';

          if (currentPath && currentPath !== '' && window.opener) {
              window.opener.postMessage({
                  type: 'directorySelected',
                  path: currentPath
              }, '*');
              window.close();
          } else if (currentPath && currentPath !== '') {
              alert('Выбрана папка: ' + currentPath);
              window.close();
          } else {
              alert('Пожалуйста, выберите папку');
          }
      } catch (e) {
          console.error('Error selecting directory:', e);
          alert('Ошибка при выборе папки');
      }
  }

  // Отключаем кнопки выбора при ошибке
  document.addEventListener('DOMContentLoaded', function() {
      loadTheme();

      const errorExists = document.querySelector('.alert-danger');
      if (errorExists) {
          document.getElementById('selectButton').disabled = true;
          document.getElementById('footerSelectButton').disabled = true;

          // Фокус на кнопке "В корень"
          const rootBtn = document.querySelector('[onclick="navigateToRoot()"]');
          if (rootBtn) rootBtn.focus();
      }

      // Добавляем обработчики для всех элементов с data-path
      document.querySelectorAll('[data-path]').forEach(item => {
          item.addEventListener('click', function() {
              navigateToPath(this.getAttribute('data-path'));
          });
      });
  });

  // Обработка нажатия клавиш
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
          const errorExists = document.querySelector('.alert-danger');
          if (!errorExists) {
              selectCurrentDirectory();
          }
      } else if (e.key === 'Escape') {
          window.close();
      }
  });
</script>
</body>
</html>