<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Выбор папки для загрузки</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .directory-item { cursor: pointer; transition: background-color 0.2s; }
    .directory-item:hover { background-color: #f8f9fa; }
    .file-item { color: #6c757d; }
    .error-card { border: 2px solid #dc3545; }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="card" th:class="${error != null} ? 'error-card' : ''">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-folder-open me-2"></i>
        Выберите папку для загрузки
      </h5>
      <div>
        <button type="button" class="btn btn-sm btn-outline-primary me-2"
                onclick="navigateToRoot()">
          <i class="fas fa-home me-1"></i>В корень
        </button>
        <button type="button" class="btn btn-sm btn-success"
                id="selectButton"
                onclick="selectCurrentDirectory()">
          <i class="fas fa-check me-1"></i>Выбрать
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Ошибки -->
      <div th:if="${error != null}" class="alert alert-danger mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Ошибка:</strong>
            <span th:text="${error}"></span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger ms-3"
                  onclick="navigateToRoot()">
            <i class="fas fa-home me-1"></i>В корень
          </button>
        </div>
      </div>

      <!-- Контент при отсутствии ошибок -->
      <div th:if="${error == null}">
        <!-- Корневой уровень -->
        <div th:if="${drives != null}">
          <h6 class="mb-3">Доступные диски:</h6>
          <div class="list-group">
            <a th:each="drive : ${drives}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${drive}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-hdd me-2 text-primary"></i>
              <span th:text="${drive}"></span>
            </a>
          </div>
        </div>

        <!-- Уровень с папками -->
        <div th:if="${currentPath != null and drives == null}">
          <!-- Навигация -->
          <nav class="mb-3">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="#" onclick="navigateToRoot()">Корень</a>
              </li>
              <li class="breadcrumb-item active" th:text="${currentPath}"></li>
            </ol>
          </nav>

          <!-- Содержимое папки -->
          <div class="list-group">
            <!-- Кнопка "Наверх" -->
            <a th:if="${parentPath != null}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${parentPath}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-arrow-up me-2 text-muted"></i>
              На уровень выше
            </a>

            <!-- Папки -->
            <a th:each="item : ${items}"
               th:if="${item.directory}"
               class="list-group-item list-group-item-action directory-item"
               th:attr="data-path=${item.path}"
               onclick="navigateToPath(this.getAttribute('data-path'))">
              <i class="fas fa-folder me-2 text-warning"></i>
              <span th:text="${item.name}"></span>
            </a>

            <!-- Файлы -->
            <div th:each="item : ${items}"
                 th:unless="${item.directory}"
                 class="list-group-item file-item">
              <i class="fas fa-file me-2 text-secondary"></i>
              <span th:text="${item.name}"></span>
              <small class="float-end" th:text="${item.size}"></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Сообщение при ошибке -->
      <div th:if="${error != null}" class="text-center py-4">
        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
        <h5 class="text-danger">Не удалось открыть директорию</h5>
        <p class="text-muted">Пожалуйста, выберите другую папку или вернитесь в корневую директорию</p>
        <button type="button" class="btn btn-primary" onclick="navigateToRoot()">
          <i class="fas fa-home me-1"></i>Вернуться в корень
        </button>
      </div>
    </div>
    <div class="card-footer">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted" th:if="${currentPath != null and error == null}">
          Текущий путь: <code th:text="${currentPath}"></code>
        </small>
        <small class="text-muted" th:if="${error != null}">
          Неверный путь: <code th:text="${currentPath}"></code>
        </small>
        <div>
          <button type="button" class="btn btn-outline-primary me-2"
                  onclick="navigateToRoot()">
            <i class="fas fa-home me-1"></i>В корень
          </button>
          <button type="button" class="btn btn-secondary me-2"
                  onclick="window.close()">
            Отмена
          </button>
          <button type="button" class="btn btn-primary"
                  id="footerSelectButton"
                  onclick="selectCurrentDirectory()">
            <i class="fas fa-check me-1"></i>Выбрать эту папку
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Функция для навигации
  function navigateToPath(path) {
      try {
          if (!path) return;

          // Кодируем путь для URL
          const encodedPath = encodeURIComponent(path);
          window.location.href = '/yt-dlp/browse?path=' + encodedPath;
      } catch (e) {
          console.error('Error navigating to path:', e);
          navigateToRoot();
      }
  }

  function navigateToRoot() {
      window.location.href = '/yt-dlp/browse';
  }

  // Функция для выбора текущей директории
  function selectCurrentDirectory() {
      try {
          // Получаем текущий путь из данных страницы
          const currentPathElement = document.querySelector('code');
          const currentPath = currentPathElement ? currentPathElement.textContent : '';

          if (currentPath && currentPath !== '' && window.opener) {
              window.opener.postMessage({
                  type: 'directorySelected',
                  path: currentPath
              }, '*');
              window.close();
          } else if (currentPath && currentPath !== '') {
              alert('Выбрана папка: ' + currentPath);
              window.close();
          } else {
              alert('Пожалуйста, выберите папку');
          }
      } catch (e) {
          console.error('Error selecting directory:', e);
          alert('Ошибка при выборе папки');
      }
  }

  // Отключаем кнопки выбора при ошибке
  document.addEventListener('DOMContentLoaded', function() {
      const errorExists = document.querySelector('.alert-danger');
      if (errorExists) {
          document.getElementById('selectButton').disabled = true;
          document.getElementById('footerSelectButton').disabled = true;

          // Фокус на кнопке "В корень"
          const rootBtn = document.querySelector('[onclick="navigateToRoot()"]');
          if (rootBtn) rootBtn.focus();
      }

      // Добавляем обработчики для всех элементов с data-path
      document.querySelectorAll('[data-path]').forEach(item => {
          item.addEventListener('click', function() {
              navigateToPath(this.getAttribute('data-path'));
          });
      });
  });

  // Обработка нажатия клавиш
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
          const errorExists = document.querySelector('.alert-danger');
          if (!errorExists) {
              selectCurrentDirectory();
          }
      } else if (e.key === 'Escape') {
          window.close();
      }
  });
</script>
</body>
</html>